<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Interface - Trusted Web Application</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <style>
        .sql-editor {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
        }
        .results-table {
            font-size: 12px;
        }
        .status-badge {
            font-size: 0.8rem;
        }
        .webapp-indicator {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .token-info {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border-radius: 10px;
        }
        .sidebar {
            background-color: #f8f9fa;
            min-height: calc(100vh - 56px);
        }
        .main-content {
            min-height: calc(100vh - 56px);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-database me-2"></i>
                Databricks SQL Interface
            </a>
            <div class="d-flex align-items-center gap-3">
                <div class="webapp-indicator">
                    <i class="fas fa-server me-1"></i>
                    Web App (Session-Independent)
                </div>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-sign-out-alt me-1"></i>
                    Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 sidebar p-4">
                <!-- Connection Info -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-plug me-2"></i>
                            Connection Info
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="small">
                            <div class="mb-2">
                                <strong>Workspace:</strong><br>
                                <code class="small">{{ server_hostname }}</code>
                            </div>
                            <div class="mb-2">
                                <strong>Connected:</strong><br>
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle me-1"></i>
                                    Active
                                </span>
                            </div>
                            <div>
                                <strong>Auth Type:</strong><br>
                                <span class="badge bg-info">Web Application</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Token Status -->
                <div class="card mb-3 token-info">
                    <div class="card-header text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-key me-2"></i>
                            Token Status
                        </h6>
                    </div>
                    <div class="card-body text-white">
                        <div class="small">
                            <div class="mb-2">
                                <strong>Obtained:</strong><br>
                                <span id="token-obtained">{{ token_obtained }}</span>
                            </div>
                            <div class="mb-2">
                                <strong>Expires:</strong><br>
                                <span id="expires-at">Calculating...</span>
                            </div>
                            <div class="mb-2">
                                <strong>Refresh Token:</strong><br>
                                <span class="badge bg-success">
                                    <i class="fas fa-infinity me-1"></i>
                                    Session-Independent
                                </span>
                            </div>
                            <div>
                                <strong>Auto-Refresh:</strong><br>
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-sync-alt me-1"></i>
                                    Every 55min
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Warehouse Info -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-server me-2"></i>
                            Warehouse Information
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="small">
                            <div class="mb-2">
                                <strong>How to find Warehouse ID:</strong>
                            </div>
                            <ol class="small">
                                <li>Go to Databricks SQL</li>
                                <li>Click "Warehouses" in sidebar</li>
                                <li>Click your warehouse name</li>
                                <li>Copy ID from URL or Connection Details</li>
                            </ol>
                            <div class="mt-2">
                                <strong>Example:</strong><br>
                                <code class="small">168bbc0657bfe886</code>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SQL Examples Card -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-code me-2"></i>
                            SQL Query Examples
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="small">
                            <div class="mb-3">
                                <strong>Basic Queries:</strong>
                                <div class="mt-1">
                                    <button class="btn btn-outline-primary btn-sm me-1 mb-1" onclick="insertExample('SELECT current_timestamp()')">Current Time</button>
                                    <button class="btn btn-outline-primary btn-sm me-1 mb-1" onclick="insertExample('SELECT current_user()')">Current User</button>
                                    <button class="btn btn-outline-primary btn-sm me-1 mb-1" onclick="insertExample('SHOW DATABASES')">Show Databases</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <strong>Data Exploration:</strong>
                                <div class="mt-1">
                                    <button class="btn btn-outline-success btn-sm me-1 mb-1" onclick="insertExample('SHOW TABLES IN default')">Show Tables</button>
                                    <button class="btn btn-outline-success btn-sm me-1 mb-1" onclick="insertExample('DESCRIBE EXTENDED table_name')">Describe Table</button>
                                    <button class="btn btn-outline-success btn-sm me-1 mb-1" onclick="insertExample('SELECT * FROM table_name LIMIT 10')">Sample Data</button>
                                </div>
                            </div>
                            <div class="mb-2">
                                <strong>Analytics:</strong>
                                <div class="mt-1">
                                    <button class="btn btn-outline-info btn-sm me-1 mb-1" onclick="insertExample('SELECT COUNT(*) FROM table_name')">Row Count</button>
                                    <button class="btn btn-outline-info btn-sm me-1 mb-1" onclick="insertExample('SELECT column, COUNT(*) FROM table_name GROUP BY column')">Group By</button>
                                    <button class="btn btn-outline-info btn-sm me-1 mb-1" onclick="insertExample('SELECT AVG(column), MAX(column), MIN(column) FROM table_name')">Aggregates</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 main-content p-4">
                <div class="row">
                    <div class="col-12">
                        <h2 class="mb-4">
                            <i class="fas fa-terminal me-2"></i>
                            SQL Query Interface
                            <small class="text-muted fs-6">Trusted Web Application</small>
                        </h2>
                    </div>
                </div>

                <!-- SQL Query Form -->
                <form id="sql-form">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="warehouse_id" class="form-label">
                                <strong><i class="fas fa-server me-1"></i> SQL Warehouse ID</strong>
                            </label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="warehouse_id" 
                                name="warehouse_id" 
                                value="{{ default_warehouse_id }}"
                                placeholder="Enter your SQL Warehouse ID (e.g., 168bbc0657bfe886)"
                                required
                            >
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Find your Warehouse ID in Databricks SQL → Warehouses → Click your warehouse → Copy the ID from the URL or settings.
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">
                                <strong><i class="fas fa-info-circle me-1"></i> Warehouse Used</strong>
                            </label>
                            <div class="form-control-plaintext">
                                <span id="warehouse-used" class="text-muted">
                                    <small>Will show after query execution</small>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="sql_query" class="form-label">
                            <strong><i class="fas fa-code me-1"></i> SQL Query</strong>
                        </label>
                        <textarea 
                            class="form-control sql-editor" 
                            id="sql_query" 
                            name="sql_query" 
                            rows="8" 
                            placeholder="Enter your SQL query here...&#10;&#10;Example:&#10;SELECT * FROM information_schema.tables LIMIT 10;"
                            required
                        ></textarea>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-play me-2"></i>
                            Execute Query
                        </button>
                        <div class="d-flex align-items-center gap-3">
                            <span>Status: <span id="query-status" class="badge bg-secondary">Ready</span></span>
                            <button type="button" class="btn btn-outline-secondary" onclick="clearResults()">
                                <i class="fas fa-trash me-1"></i>
                                Clear Results
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Results Section -->
                <div id="results-container" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-table me-2"></i>
                                Query Results
                            </h5>
                            <div>
                                <span class="badge bg-info me-2">
                                    <i class="fas fa-clock me-1"></i>
                                    <span id="execution-time">-</span>
                                </span>
                                <span class="badge bg-success">
                                    <i class="fas fa-server me-1"></i>
                                    Warehouse: <span id="result-warehouse">-</span>
                                </span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="results-content">
                                <!-- Results will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
    
    <script>
        // Token countdown timer (force 60 minutes for Databricks workspace tokens)
        let remainingSeconds = 3600; // Always start from 60 minutes
        
        function updateTokenCountdown() {
            const expiresAt = document.getElementById('expires-at');
            if (expiresAt && remainingSeconds > 0) {
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;
                expiresAt.textContent = `Expires in ${minutes}m ${seconds}s`;
                remainingSeconds--;
            } else if (expiresAt) {
                expiresAt.textContent = 'Token expired (will auto-refresh)';
                expiresAt.classList.add('text-warning');
            }
        }
        
        // Start the countdown immediately and update every second
        updateTokenCountdown();
        setInterval(updateTokenCountdown, 1000);

        // Function to insert SQL examples into the query textarea
        function insertExample(query) {
            const textarea = document.getElementById('sql_query');
            textarea.value = query;
            textarea.focus();
        }

        // SQL Form submission
        document.getElementById('sql-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const statusElement = document.getElementById('query-status');
            const resultsContainer = document.getElementById('results-container');
            const warehouseUsedElement = document.getElementById('warehouse-used');
            
            const query = document.getElementById('sql_query').value;
            const warehouseId = document.getElementById('warehouse_id').value;
            
            if (!query) {
                alert('Please enter a SQL query');
                return;
            }
            
            if (!warehouseId) {
                alert('Please enter a Warehouse ID');
                return;
            }
            
            // Update status
            statusElement.innerHTML = '<span class="badge bg-warning">Executing...</span>';
            resultsContainer.style.display = 'none';
            
            try {
                const response = await fetch('/execute-sql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        warehouse_id: warehouseId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusElement.innerHTML = '<span class="badge bg-success">Success</span>';
                    warehouseUsedElement.innerHTML = `<small class="text-success">${result.warehouse_id}</small>`;
                    displayResults(result.result, result.executed_at, result.warehouse_id);
                    resultsContainer.style.display = 'block';
                } else {
                    statusElement.innerHTML = '<span class="badge bg-danger">Error</span>';
                    alert('Query Error: ' + result.error);
                }
                
            } catch (error) {
                statusElement.innerHTML = '<span class="badge bg-danger">Error</span>';
                alert('Network Error: ' + error.message);
            }
        });

        function displayResults(result, executedAt, warehouseId) {
            const resultsContent = document.getElementById('results-content');
            const executionTime = document.getElementById('execution-time');
            const resultWarehouse = document.getElementById('result-warehouse');
            
            // Update metadata
            executionTime.textContent = new Date(executedAt).toLocaleTimeString();
            resultWarehouse.textContent = warehouseId;
            
            // Display results
            if (result.result && result.result.data_array && result.result.data_array.length > 0) {
                const data = result.result.data_array;
                const columns = result.result.manifest?.schema?.columns || [];
                
                let html = '<div class="table-responsive"><table class="table table-striped table-hover results-table">';
                
                // Headers
                if (columns.length > 0) {
                    html += '<thead class="table-dark"><tr>';
                    columns.forEach(col => {
                        html += `<th>${col.name}</th>`;
                    });
                    html += '</tr></thead>';
                }
                
                // Data rows
                html += '<tbody>';
                data.forEach(row => {
                    html += '<tr>';
                    row.forEach(cell => {
                        html += `<td>${cell !== null ? cell : '<em class="text-muted">null</em>'}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table></div>';
                
                // Add summary
                html += `<div class="mt-3"><small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    ${data.length} rows returned
                </small></div>`;
                
                resultsContent.innerHTML = html;
            } else {
                resultsContent.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Query executed successfully but returned no data.
                    </div>
                `;
            }
        }

        function clearResults() {
            document.getElementById('results-container').style.display = 'none';
            document.getElementById('query-status').innerHTML = '<span class="badge bg-secondary">Ready</span>';
            document.getElementById('warehouse-used').innerHTML = '<small class="text-muted">Will show after query execution</small>';
        }
    </script>
</body>
</html>
